<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.51" />
    <meta name="description" content="for learning">
<meta name="author" content="maoqide">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/images/favicon.png" type="image/x-icon" />
    <title>Deploy Mysql on Kubernetes :: Maoqide</title>

    
    <link href="/css/nucleus.css?1558007030" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1558007030" rel="stylesheet">
    <link href="/css/hybrid.css?1558007030" rel="stylesheet">
    <link href="/css/featherlight.min.css?1558007030" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1558007030" rel="stylesheet">
    <link href="/css/auto-complete.css?1558007030" rel="stylesheet">
    <link href="/css/theme.css?1558007030" rel="stylesheet">
    <link href="/css/hugo-theme.css?1558007030" rel="stylesheet">
    
    
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?c3c6dd2eb79bc741d95463b6040ac868";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
    <script src="/js/jquery-2.x.min.js?1558007030"></script>

    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/cloud/deploy-mysql-on-kubernetes/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="">
  <svg  width="100%" height="100%" viewBox="0 0 504 140" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <text x="30" y="110" fill="#F1F4F5" font-weight="bold" font-family="'Courier New', Courier, monospace" font-size="80">Maoqide</text>

    
  </svg>
</a>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-close"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1558007030"></script>
<script type="text/javascript" src="/js/auto-complete.js?1558007030"></script>
<script type="text/javascript">
    
        var baseurl = "";
    
</script>
<script type="text/javascript" src="/js/search.js?1558007030"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/golang/" title="Golang" class="dd-item 
        
        
        
        ">
      <a href="/golang/">
          Golang
          
            <i class="fas read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/golang/golang-mutex/" title="Golang Mutex" class="dd-item ">
        <a href="/golang/golang-mutex/">
        Golang Mutex
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/golang/goroutine/" title="Goroutine 的管理" class="dd-item ">
        <a href="/golang/goroutine/">
        Goroutine 的管理
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/collection/" title="Collection" class="dd-item 
        
        
        
        ">
      <a href="/collection/">
          Collection
          
            <i class="fas read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/collection/collection-2/" title="Collection 2" class="dd-item ">
        <a href="/collection/collection-2/">
        Collection 2
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/collection/collection-1/" title="Collection 1" class="dd-item ">
        <a href="/collection/collection-1/">
        Collection 1
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/algorithm/" title="Algorithm" class="dd-item 
        
        
        
        ">
      <a href="/algorithm/">
          Algorithm
          
            <i class="fas read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/algorithm/basic-data-structure/" title="Basic Data Structure" class="dd-item 
        
        
        
        ">
      <a href="/algorithm/basic-data-structure/">
          Basic Data Structure
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/cloud/" title="Cloud" class="dd-item 
        parent
        
        
        ">
      <a href="/cloud/">
          Cloud
          
            <i class="fas read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/cloud/deploy-mysql-on-kubernetes/" title="Deploy Mysql on Kubernetes" class="dd-item 
        parent
        active
        
        ">
      <a href="/cloud/deploy-mysql-on-kubernetes/">
          Deploy Mysql on Kubernetes
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/cloud/sample-controller/" title="Sample Controller" class="dd-item 
        
        
        
        ">
      <a href="/cloud/sample-controller/">
          Sample Controller
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/cloud/building-an-operator-for-kubernetes-with-the-sample-controller/" title="Building an Operator for Kubernetes With the Sample Controller" class="dd-item ">
        <a href="/cloud/building-an-operator-for-kubernetes-with-the-sample-controller/">
        Building an Operator for Kubernetes With the Sample Controller
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/cloud/kube-scheduler-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" title="Kube Scheduler 源码阅读" class="dd-item ">
        <a href="/cloud/kube-scheduler-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">
        Kube Scheduler 源码阅读
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/cloud/container-network/" title="Container Network" class="dd-item 
        
        
        
        ">
      <a href="/cloud/container-network/">
          Container Network
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/cloud/docker-%E5%8E%9F%E7%90%86/" title="Docker 原理" class="dd-item 
        
        
        
        ">
      <a href="/cloud/docker-%E5%8E%9F%E7%90%86/">
          Docker 原理
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/cloud/controller-manager-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" title="Controller Manager 源码阅读" class="dd-item ">
        <a href="/cloud/controller-manager-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">
        Controller Manager 源码阅读
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/cloud/apiserver-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" title="Apiserver 源码阅读" class="dd-item ">
        <a href="/cloud/apiserver-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">
        Apiserver 源码阅读
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/cloud/kubelet/" title="Kubelet" class="dd-item 
        
        
        
        ">
      <a href="/cloud/kubelet/">
          Kubelet
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/cloud/%E9%98%BF%E9%87%8C%E4%BA%91%E4%B8%BB%E6%9C%BA%E6%90%AD%E5%BB%BA-k8s-%E9%9B%86%E7%BE%A4/" title="阿里云主机搭建 K8S 集群" class="dd-item ">
        <a href="/cloud/%E9%98%BF%E9%87%8C%E4%BA%91%E4%B8%BB%E6%9C%BA%E6%90%AD%E5%BB%BA-k8s-%E9%9B%86%E7%BE%A4/">
        阿里云主机搭建 K8S 集群
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/notes/" title="Notes" class="dd-item 
        
        
        
        ">
      <a href="/notes/">
          Notes
          
            <i class="fas read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/notes/publish-your-site-on-k8s/" title="将网站部署在 Kubernetes 上" class="dd-item 
        
        
        
        ">
      <a href="/notes/publish-your-site-on-k8s/">
          将网站部署在 Kubernetes 上
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/notes/build-blog-with-hugo/" title="Build Blog With Hugo" class="dd-item ">
        <a href="/notes/build-blog-with-hugo/">
        Build Blog With Hugo
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/contact/" title="Contact" class="dd-item 
        
        
        
        ">
      <a href="/contact/">
          Contact
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3></h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://github.com/maoqide"><i class='fab fa-github'></i> Github</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="http://getgrav.org">Grav</a> and <a href="http://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                   Deploy Mysql on Kubernetes 
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#环境准备">环境准备</a></li>
<li><a href="#代码编译">代码编译</a></li>
<li><a href="#部署-operator">部署 operator</a></li>
<li><a href="#创建-mysql-集群">创建 mysql 集群</a></li>
<li><a href="#通过-haproxy-ingress-允许外部访问">通过 haproxy-ingress 允许外部访问</a></li>
<li><a href="#附件">附件</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>Deploy Mysql on Kubernetes</h1>
          

        


<p>本文通过 <a href="https://github.com/oracle/mysql-operator">mysql-operator</a> 在kubernetes集群部署高可用的mysql statefulset。</p>

<h2 id="环境准备">环境准备</h2>

<p>本文使用的开源 operator 项目 <a href="https://github.com/oracle/mysql-operator">mysql-operator</a> 配死只支持 mysql 8.0.11 以上的版本，改了下代码，支持 5.7.0 以上版本，<a href="https://github.com/maoqide/mysql-operator">项目地址</a>，本文部署的是 mysql-5.7.26，使用的 dockerhub 上的镜像 mysql/mysql-server:5.7.26。</p>

<h2 id="代码编译">代码编译</h2>

<p>git clone 下载该项目，进入到代码目录，执行<code>sh hack/build.sh</code>，编译代码得到二进制文件 mysql-agent 和 mysql-operator，将二进制文件放入 <code>bin/linux_amd64</code>，执行<code>docker build -f docker/mysql-agent/Dockerfile -t $IMAGE_NAME_AGENT .</code>，<code>docker build -f docker/mysql-operator/Dockerfile -t $IMAGE_NAME_OPERATOR .</code>构建镜像，mysql-operator 生成的镜像为 operator 的镜像，mysql-agent 生成的是镜像，在创建mysql服务时，作为sidecar和mysql-server容器起在同一个pod中。</p>

<h2 id="部署-operator">部署 operator</h2>

<p>先根据 <a href="https://github.com/maoqide/mysql-operator/blob/master/docs/tutorial.md">文档</a> 部署 mysql-operator 的 Deployment，文档中是使用 helm 安装，不希望安装 helm 和 tiller 的话，可以只安装一个 helm 客户端，进入到代码目录，再执行<code>helm template --name mysql-operator mysql-operator</code>生成部署所需要的yaml文件，然后直接执行<code>kubectl apply -f mysql-operator.yaml</code>创建 operator。这个yaml创建了operator所需的CRD类型，operator 的 Deployment 和 operator 所需的 RBAC 权限等。</p>

<pre><code class="language-shell"># change directory into mysql-operator
cd mysql-operator
# generate mysql-operator.yaml
helm template --name mysql-operator mysql-operator &gt; mysql-operator.yaml
# deploy on kubernetes
kubectl apply -f mysql-operator.yaml
# deployed.
[root@localhost]$ kubectl get deploy -n mysql-operator
NAME             READY   UP-TO-DATE   AVAILABLE   AGE
mysql-operator   1/1     1            1           2d5h
</code></pre>

<h2 id="创建-mysql-集群">创建 mysql 集群</h2>

<p>本文创建的集群为3节点的 mysql，一个节点为 master，二个为 slave，master节点可读写，slave节点为只读，使用 kubernetes Local PV 作持久化存储。<br />
首先，为每个节点创建一个PV，Local PV 需要定义<code>nodeAffinity</code>，约束创建的节点。</p>

<pre><code class="language-yaml">apiVersion: v1
kind: PersistentVolume
metadata:
  name: mypv0
spec:
  capacity:
    storage: 1Gi
  volumeMode: Filesystem
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete
  storageClassName: mysql-storage
  local:
    path: /data/mysql-data
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - 192.168.0.1

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mypv1
spec:
  capacity:
    storage: 1Gi
  volumeMode: Filesystem
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete
  storageClassName: mysql-storage
  local:
    path: /data/mysql-data
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - 192.168.0.2

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mypv2
spec:
  capacity:
    storage: 1Gi
  volumeMode: Filesystem
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete
  storageClassName: mysql-storage
  local:
    path: /data/mysql-data
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - 192.168.0.3
</code></pre>

<pre><code class="language-shell"># create pv
kubectl create -f pv.yaml
# get presistence volume
[root@localhost]$ kubectl get pv
mypv-0               1Gi        RWO            Delete           Available                                                                     mysql-storage               4s
mypv-1               1Gi        RWO            Delete           Available                                                                     mysql-storage               4s
mypv-2               1Gi        RWO            Delete           Available                                                                     mysql-storage               4s
</code></pre>

<p>接着，需要在创建 mysql 的 namespace 下，为要创建的 mysql 创建对应的 RBAC 权限。</p>

<pre><code class="language-yaml">apiVersion: v1
kind: ServiceAccount
metadata:
  name: mysql-agent
  namespace: mysql2
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: mysql-agent
  namespace: mysql2
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: mysql-agent
subjects:
- kind: ServiceAccount
  name: mysql-agent
  namespace: mysql2
</code></pre>

<p>如果需要自定义 mysql 的密码，需要为其创建一个 secret，密码需要使用base64加密。linux 下执行 <code>echo -n 'password' | base64</code> 为密码加密。</p>

<pre><code class="language-yaml">apiVersion: v1
data:
  password: cm9vdA==
kind: Secret
metadata:
  labels:
    v1alpha1.mysql.oracle.com/cluster: mysql
  name: mysql-pv-root-password
  namespace: mysql2
</code></pre>

<pre><code class="language-shell">kubectl apply -f rbac.yaml
kubectl apply -f secret.yaml
</code></pre>

<p>在创建 operator 的时候，已经创建了如下的crd类型，部署mysql集群所需创建的就是 mysqlclusters 类型的资源。</p>

<pre><code class="language-shell">[root@localhost]$ kubectl get crd  | grep mysql
mysqlbackups.mysql.oracle.com                2019-05-14T02:51:11Z
mysqlbackupschedules.mysql.oracle.com        2019-05-14T02:51:11Z
mysqlclusters.mysql.oracle.com               2019-05-14T02:51:11Z
mysqlrestores.mysql.oracle.com               2019-05-14T02:51:11Z
</code></pre>

<p>接下来开始创建 operator 自定义资源类型(CRD)的实例 mysqlclusters。</p>

<pre><code class="language-yaml">apiVersion: mysql.oracle.com/v1alpha1
kind: Cluster
metadata:
  name: mysql
  namespace: mysql2
spec:  
  # 和mysql-server镜像版本的tag一直
  version: 5.7.26
  repository: 20.26.28.56/dcos/mysql-server
  # 节点数量
  members: 3
  # 指定 mysql 密码，和之前创建的secret名称一致
  rootPasswordSecret:
    name: mysql-pv-root-password
  resources:
    agent:
      limits:
        cpu: 500m
        memory: 200Mi
      requests:
        cpu: 300m
        memory: 100Mi
    server:
      limits:
        cpu: 1000m
        memory: 1000Mi
      requests:
        cpu: 500m
        memory: 500Mi
  volumeClaimTemplate:
    metadata:
      name: mysql-pv
    spec:
      accessModes: [ &quot;ReadWriteOnce&quot; ]
      storageClassName: &quot;mysql-storage&quot;
      resources:
        requests:
          storage: 1Gi
</code></pre>

<pre><code class="language-shell">kubectl apply -f mysql.yaml
</code></pre>

<p>执行后，会看到 kubernetes 在该 namespace 下开始拉起 mysql 的 statefulset，并会创建一个 headless service。</p>

<pre><code class="language-shell">[root@localhost]$ kubectl get all -n mysql2
NAME                                                      READY   STATUS    RESTARTS   AGE
pod/mysql-0                                               2/2     Running   0          8h
pod/mysql-1                                               2/2     Running   0          8h
pod/mysql-2                                               2/2     Running   0          8h


NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/mysql     ClusterIP   None            &lt;none&gt;        3306/TCP   21h


NAME                     READY   AGE
statefulset.apps/mysql   1/1     21h
</code></pre>

<p>此时执行<code>hack/cluster-status.sh</code>脚本，会得到如下集群信息：</p>

<pre><code class="language-json">{
    &quot;clusterName&quot;: &quot;Cluster&quot;, 
    &quot;defaultReplicaSet&quot;: {
        &quot;name&quot;: &quot;default&quot;, 
        &quot;primary&quot;: &quot;mysql-0.mysql:3306&quot;, 
        &quot;ssl&quot;: &quot;DISABLED&quot;, 
        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, 
        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures. 2 members are not active&quot;, 
        &quot;topology&quot;: {
            &quot;mysql-0.mysql:3306&quot;: {
                &quot;address&quot;: &quot;mysql-0.mysql:3306&quot;, 
                &quot;mode&quot;: &quot;R/W&quot;, 
                &quot;readReplicas&quot;: {}, 
                &quot;role&quot;: &quot;HA&quot;, 
                &quot;status&quot;: &quot;ONLINE&quot;
            }, 
            &quot;mysql-1.mysql:3306&quot;: {
                &quot;address&quot;: &quot;mysql-1.mysql:3306&quot;, 
                &quot;mode&quot;: &quot;n/a&quot;, 
                &quot;readReplicas&quot;: {}, 
                &quot;role&quot;: &quot;HA&quot;, 
                &quot;status&quot;: &quot;ONLINE&quot;
            }, 
            &quot;mysql-2.mysql:3306&quot;: {
                &quot;address&quot;: &quot;mysql-2.mysql:3306&quot;, 
                &quot;mode&quot;: &quot;n/a&quot;, 
                &quot;readReplicas&quot;: {}, 
                &quot;role&quot;: &quot;HA&quot;, 
                &quot;status&quot;: &quot;ONLINE&quot;
            }
        }, 
        &quot;topologyMode&quot;: &quot;Single-Primary&quot;
    }, 
    &quot;groupInformationSourceMember&quot;: &quot;mysql-0.mysql:3306&quot;
}
</code></pre>

<p>通过DNS地址 <code>mysql-0.mysql.mysql2.svc.cluster.local:3306</code> 可以连接到数据库进行读写操作。此时一个多节点的mysql集群已经部署完成，但是，集群外部的服务还无法访问数据库。</p>

<h2 id="通过-haproxy-ingress-允许外部访问">通过 haproxy-ingress 允许外部访问</h2>

<p>首先，headless service只能通过集群内 DNS 访问服务，要外部访问，还需要另外创建一个 Service。为了让外部可以访问到 mysql-0 的服务，我们为 mysql-0 创建一个ClusterIP 类型的服务。</p>

<pre><code class="language-yaml">kind: Service
apiVersion: v1
metadata:
  name: mysql-0
  namespace: mysql2
spec:
  selector:
    # 通过 selector 将 pod 约束到 mysql-0
   statefulset.kubernetes.io/pod-name: mysql-0
  ports:
    - protocol: TCP
      port: 3306
      targetPort: 3306
</code></pre>

<p>接着，需要创建一个ingress-controller，本文选用的是 <a href="https://github.com/jcmoraisjr/haproxy-ingress">haproxy-ingress</a>。<br />
由于 mysql 服务通过 TCP 协议通信，kubernetes ingress 默认只支持 http 和 https，haproxy-ingress 提供了通过 configmap 的方法，配置 TCP 服务的端口，需要先创建一个 configmap，configmap的data中，key为HAProxy监听的端口，value 为需要转发的 service 的服务和端口。</p>

<pre><code class="language-yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-tcp
  namespace: mysql2
data:
  &quot;3306&quot;: &quot;mysql2/mysql-0:3306&quot;
</code></pre>

<pre><code class="language-shell">kubectl apply -f mysql-0.yaml
kubectl apply -f tcp-svc.yaml
</code></pre>

<p>接下来创建 ingress-controller，</p>

<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    run: haproxy-ingress
  name: haproxy-ingress-192.168.0.1-30080
  namespace: mysql2
spec:
  replicas: 1
  selector:
    matchLabels:
      run: haproxy-ingress
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        run: haproxy-ingress
    spec:
      tolerations:
      - key: app 
        operator: Equal 
        value: haproxy
        effect: NoSchedule
      serviceAccount: ingress-controller      
      nodeSelector:
        kubernetes.io/hostname: 192.168.0.1
      containers:
      - args:
        - --tcp-services-configmap=$(POD_NAMESPACE)/mysql-tcp
        - --default-backend-service=$(POD_NAMESPACE)/mysql
        - --default-ssl-certificate=$(POD_NAMESPACE)/tls-secret
        - --ingress-class=ha-mysql
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        image: jcmoraisjr/haproxy-ingress
        name: haproxy-ingress
        ports:
          # 和 configmap 中定义的端口对应
        - containerPort: 3306
          hostPort: 3306
          name: http
          protocol: TCP
        - containerPort: 443
          name: https
          protocol: TCP
        - containerPort: 1936
          hostPort: 30081
          name: stat
          protocol: TCP
</code></pre>

<pre><code class="language-yaml">apiVersion: v1
kind: ServiceAccount
metadata:
  name: ingress-controller

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ingress-controller
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - configmaps
      - pods
      - secrets
      - namespaces
    verbs:
      - get
  - apiGroups:
      - &quot;&quot;
    resources:
      - configmaps
    verbs:
      - get
      - update
  - apiGroups:
      - &quot;&quot;
    resources:
      - configmaps
    verbs:
      - create
  - apiGroups:
      - &quot;&quot;
    resources:
      - endpoints
    verbs:
      - get
      - create
      - update

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ingress-controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: ingress-controller
subjects:
  - kind: ServiceAccount
    name: ingress-controller
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: ingress-controller

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: ingress-controller
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - configmaps
      - endpoints
      - nodes
      - pods
      - secrets
    verbs:
      - list
      - watch
  - apiGroups:
      - &quot;&quot;
    resources:
      - nodes
    verbs:
      - get
  - apiGroups:
      - &quot;&quot;
    resources:
      - services
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - &quot;extensions&quot;
    resources:
      - ingresses
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - &quot;&quot;
    resources:
      - events
    verbs:
      - create
      - patch
  - apiGroups:
      - &quot;extensions&quot;
    resources:
      - ingresses/status
    verbs:
      - update

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: ingress-controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ingress-controller
subjects:
  - kind: ServiceAccount
    name: ingress-controller
    namespace: mysql2
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: ingress-controller
</code></pre>

<pre><code class="language-shell">kubectl apply -f ingress-controller.yaml
kubectl apply -f ingress-rbac.yaml -n mysql2
</code></pre>

<p>最后创建 ingress 规则：</p>

<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    ingress.kubernetes.io/ssl-redirect: &quot;false&quot;
    kubernetes.io/ingress.class: ha-mysql
  name: ha-mysql
spec:
  rules:
  - http:
      paths:
      - backend:
          serviceName: mysql-0
          servicePort: 3306
        path: /
</code></pre>

<p>此时可以通过 haproxy 的 IP + 映射端口访问到 mysql 集群。</p>

<h2 id="附件">附件</h2>

<p>以下是上面用到的 yaml 文件：<br />
- <a href="./rbac.yaml">rbac.yaml</a><br />
- <a href="./mysql.yaml">mysql.yaml</a><br />
- <a href="./secret.yaml">secret.yaml</a><br />
- <a href="./pv.yaml">pv.yaml</a><br />
- <a href="./mysql-0-svc.yaml">mysql-0-svc.yaml</a><br />
- <a href="./tcp-svc.yaml">tcp-svc.yaml</a><br />
- <a href="./ingress-controller.yaml">ingress-controller.yaml</a><br />
- <a href="./ingress-rbac.yaml">ingress-rbac.yaml</a><br />
- <a href="./ingress.yaml">ingress.yaml</a></p>

<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1558007030"></script>
    <script src="/js/perfect-scrollbar.min.js?1558007030"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1558007030"></script>
    <script src="/js/jquery.sticky.js?1558007030"></script>
    <script src="/js/featherlight.min.js?1558007030"></script>
    <script src="/js/html5shiv-printshiv.min.js?1558007030"></script>
    <script src="/js/highlight.pack.js?1558007030"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js?1558007030"></script>
    <script src="/js/learn.js?1558007030"></script>
    <script src="/js/hugo-learn.js?1558007030"></script>

    <link href="/mermaid/mermaid.css?1558007030" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1558007030"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>
