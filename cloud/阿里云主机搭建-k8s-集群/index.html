<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.51" />
    <meta name="description" content="for learning">
<meta name="author" content="maoqide">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/images/favicon.png" type="image/x-icon" />
    <title>阿里云主机搭建 K8S 集群 :: Maoqide</title>

    
    <link href="/css/nucleus.css?1550631170" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1550631170" rel="stylesheet">
    <link href="/css/hybrid.css?1550631170" rel="stylesheet">
    <link href="/css/featherlight.min.css?1550631170" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1550631170" rel="stylesheet">
    <link href="/css/auto-complete.css?1550631170" rel="stylesheet">
    <link href="/css/theme.css?1550631170" rel="stylesheet">
    <link href="/css/hugo-theme.css?1550631170" rel="stylesheet">
    
    
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?c3c6dd2eb79bc741d95463b6040ac868";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
    <script src="/js/jquery-2.x.min.js?1550631170"></script>

    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/cloud/%E9%98%BF%E9%87%8C%E4%BA%91%E4%B8%BB%E6%9C%BA%E6%90%AD%E5%BB%BA-k8s-%E9%9B%86%E7%BE%A4/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="">
  <svg  width="100%" height="100%" viewBox="0 0 504 140" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <text x="30" y="110" fill="#F1F4F5" font-weight="bold" font-family="'Courier New', Courier, monospace" font-size="80">Maoqide</text>

    
  </svg>
</a>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-close"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1550631170"></script>
<script type="text/javascript" src="/js/auto-complete.js?1550631170"></script>
<script type="text/javascript">
    
        var baseurl = "";
    
</script>
<script type="text/javascript" src="/js/search.js?1550631170"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/golang/" title="Golang" class="dd-item 
        
        
        
        ">
      <a href="/golang/">
          Golang
          
            <i class="fas read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/golang/goroutine/" title="Goroutine 的管理" class="dd-item ">
        <a href="/golang/goroutine/">
        Goroutine 的管理
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/collection/" title="Collection" class="dd-item 
        
        
        
        ">
      <a href="/collection/">
          Collection
          
            <i class="fas read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/collection/collection-2/" title="Collection 2" class="dd-item ">
        <a href="/collection/collection-2/">
        Collection 2
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/collection/collection-1/" title="Collection 1" class="dd-item ">
        <a href="/collection/collection-1/">
        Collection 1
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/algorithm/" title="Algorithm" class="dd-item 
        
        
        
        ">
      <a href="/algorithm/">
          Algorithm
          
            <i class="fas read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/algorithm/basic-data-structure/" title="Basic Data Structure" class="dd-item 
        
        
        
        ">
      <a href="/algorithm/basic-data-structure/">
          Basic Data Structure
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/cloud/" title="Cloud" class="dd-item 
        parent
        
        
        ">
      <a href="/cloud/">
          Cloud
          
            <i class="fas read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/cloud/container-network/" title="Container Network" class="dd-item 
        
        
        
        ">
      <a href="/cloud/container-network/">
          Container Network
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/cloud/docker-%E5%8E%9F%E7%90%86/" title="Docker 原理" class="dd-item 
        
        
        
        ">
      <a href="/cloud/docker-%E5%8E%9F%E7%90%86/">
          Docker 原理
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/cloud/apiserver/" title="Apiserver" class="dd-item ">
        <a href="/cloud/apiserver/">
        Apiserver
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/cloud/kubelet/" title="Kubelet" class="dd-item 
        
        
        
        ">
      <a href="/cloud/kubelet/">
          Kubelet
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/cloud/%E9%98%BF%E9%87%8C%E4%BA%91%E4%B8%BB%E6%9C%BA%E6%90%AD%E5%BB%BA-k8s-%E9%9B%86%E7%BE%A4/" title="阿里云主机搭建 K8S 集群" class="dd-item active">
        <a href="/cloud/%E9%98%BF%E9%87%8C%E4%BA%91%E4%B8%BB%E6%9C%BA%E6%90%AD%E5%BB%BA-k8s-%E9%9B%86%E7%BE%A4/">
        阿里云主机搭建 K8S 集群
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/notes/" title="Notes" class="dd-item 
        
        
        
        ">
      <a href="/notes/">
          Notes
          
            <i class="fas read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/notes/publish-your-site-on-k8s/" title="将网站部署在 Kubernetes 上" class="dd-item 
        
        
        
        ">
      <a href="/notes/publish-your-site-on-k8s/">
          将网站部署在 Kubernetes 上
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/notes/build-blog-with-hugo/" title="Build Blog With Hugo" class="dd-item ">
        <a href="/notes/build-blog-with-hugo/">
        Build Blog With Hugo
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/contact/" title="Contact" class="dd-item 
        
        
        
        ">
      <a href="/contact/">
          Contact
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3></h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://github.com/maoqide"><i class='fab fa-github'></i> Github</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="http://getgrav.org">Grav</a> and <a href="http://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                   阿里云主机搭建 K8S 集群 
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#环境">环境</a></li>
<li><a href="#安装-docker">安装 docker</a></li>
<li><a href="#配置代理">配置代理</a>
<ul>
<li><a href="#安装-shadowsocks">安装 shadowsocks</a></li>
<li><a href="#配置-shadowsocks">配置 shadowsocks</a></li>
<li><a href="#安装-privoxy">安装 privoxy</a>
<ul>
<li><a href="#配置快捷命令">配置快捷命令</a></li>
</ul></li>
</ul></li>
<li><a href="#安装-kubernetes">安装 Kubernetes</a>
<ul>
<li><a href="#安装kubeadm">安装kubeadm</a></li>
<li><a href="#创建-master-节点">创建 master 节点</a></li>
<li><a href="#创建-node-节点">创建 node 节点</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>阿里云主机搭建 K8S 集群</h1>
          

        


<p>通过阿里云ECS实例搭建K8S集群</p>

<h2 id="环境">环境</h2>

<ul>
<li>阿里云ECS * 2</li>
<li>centos7.4</li>
<li>阿里云两台机器需要内网互通（同一k可用区可以创建免费VPC高速通道实现）</li>
</ul>

<h2 id="安装-docker">安装 docker</h2>

<p><a href="https://docs.docker.com/install/linux/docker-ce/centos/">官方文档</a></p>

<pre><code class="language-shell">sudo yum install -y yum-utils \
  device-mapper-persistent-data \
  lvm2
sudo yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
sudo yum install docker-ce
</code></pre>

<h2 id="配置代理">配置代理</h2>

<ul>
<li><a href="https://github.com/shadowsocks/shadowsocks/tree/master">shadowsocks服务端</a></li>
<li>provixy</li>
<li>shadowsocks客户端 sslocal</li>
</ul>

<h3 id="安装-shadowsocks">安装 shadowsocks</h3>

<pre><code class="language-shell">yum -y install python-pip
pip install shadowsocks
</code></pre>

<h3 id="配置-shadowsocks">配置 shadowsocks</h3>

<pre><code class="language-shell">vim /etc/shadowsocks.json
</code></pre>

<pre><code class="language-json">{
    &quot;server&quot;:&quot;1.1.1.1&quot;, 			//shadowsocks server ip
    &quot;server_port&quot;:8888,				//shadowsocks server port
    &quot;local_address&quot;: &quot;127.0.0.1&quot;,	
    &quot;local_port&quot;:1080,				//default 1080
    &quot;password&quot;:&quot;ssserver_passwd&quot;,
    &quot;timeout&quot;:300,
    &quot;method&quot;:&quot;aes-256-cfb&quot;,
    &quot;fast_open&quot;: false,
    &quot;workers&quot;: 1
}

</code></pre>

<h3 id="安装-privoxy">安装 privoxy</h3>

<p>配置全局代理或 gfwlist 代理</p>

<pre><code class="language-shell">yum -y install privoxy
# 全局代理
echo 'forward-socks5 / 127.0.0.1:1080 .' &gt;&gt;/etc/privoxy/config

# gfwlist 代理
# 获取 gfwlist2privoxy 脚本
curl -4sSkL https://raw.github.com/zfl9/gfwlist2privoxy/master/gfwlist2privoxy -O

# 生成 gfwlist.action 文件
bash gfwlist2privoxy '127.0.0.1:1080'

# 检查 gfwlist.action 文件
more gfwlist.action # 一般有 5000+ 行

# 应用 gfwlist.action 文件
mv -f gfwlist.action /etc/privoxy
echo 'actionsfile gfwlist.action' &gt;&gt;/etc/privoxy/config
</code></pre>

<h4 id="配置快捷命令">配置快捷命令</h4>

<p>在 /etc/profile.d 新建 set_proxy.sh, linux开机会自动执行该目录下可执行文件</p>

<pre><code class="language-shell">vim /etc/profile.d/set_proxy.sh
</code></pre>

<pre><code class="language-shell">[root@localhost ~]$ cat /etc/profile.d/set_proxy.sh 
# Initialization script for bash and sh
# export proxy for GFW
alias proxy_on='nohup sslocal -c /etc/shadowsocks.json &amp; systemctl start privoxy'
alias proxy_off='systemctl stop privoxy &amp;&amp; pkill sslocal'
alias proxy_export='export http_proxy=http://127.0.0.1:8118 &amp;&amp; export https_proxy=http://127.0.0.1:8118 &amp;&amp; export no_proxy=localhost'
alias proxy_unset='unset http_proxy https_proxy no_proxy'
alias proxy_test='curl google.com'
</code></pre>

<p>手动执行 /etc/profile, 会重新执行/etc/profile.d下文件</p>

<pre><code class="language-shell">source /etc/profile
</code></pre>

<p>执行alias查看，发现有proxy前缀的别名，则配置成功</p>

<pre><code class="language-shell">[root@localhost ~]$ alias 
alias egrep='egrep --color=auto'
alias fgrep='fgrep --color=auto'
alias grep='grep --color=auto'
alias l.='ls -d .* --color=auto'
alias ll='ls -l --color=auto'
alias ls='ls --color=auto'
alias proxy_export='export http_proxy=http://127.0.0.1:8118 &amp;&amp; export https_proxy=http://127.0.0.1:8118 &amp;&amp; export no_proxy=localhost'
alias proxy_off='systemctl stop privoxy &amp;&amp; pkill sslocal'
alias proxy_on='nohup sslocal -c /etc/shadowsocks.json &amp; systemctl start privoxy'
alias proxy_test='curl google.com'
alias proxy_unset='unset http_proxy https_proxy no_proxy'
alias vi='vim'
alias which='alias | /usr/bin/which --tty-only --read-alias --show-dot --show-tilde'
</code></pre>

<p>执行下面命令开启代理，并配置环境变量(只对当前shell生效，若要永久生效需要在/etc/proxy中export环境变量)</p>

<pre><code class="language-shell">proxy_on &amp;&amp; proxy_export
</code></pre>

<p>执行 proxy_test 测试代理是否配置成功，出现如下输出则配置成功。</p>

<pre><code class="language-shell">[root@mqd1c2g ~]$ proxy_test 
&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;charset=utf-8&quot;&gt;
&lt;TITLE&gt;301 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;
&lt;H1&gt;301 Moved&lt;/H1&gt;
The document has moved
&lt;A HREF=&quot;http://www.google.com/&quot;&gt;here&lt;/A&gt;.
&lt;/BODY&gt;&lt;/HTML&gt;
</code></pre>

<p>参考: <a href="https://www.zfl9.com/ss-local.html">ss-local 终端代理（gfwlist）</a></p>

<h2 id="安装-kubernetes">安装 Kubernetes</h2>

<p><a href="https://kubernetes.io/docs/setup/independent/install-kubeadm/">官方文档</a></p>

<h3 id="安装kubeadm">安装kubeadm</h3>

<p>检查机器是否符合文档中的<code>Before you begin</code>的要求, 符合的话才能进行接下来的步骤。</p>

<pre><code class="language-shell">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
exclude=kube*
EOF

# Set SELinux in permissive mode (effectively disabling it)
setenforce 0
sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config

yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes

systemctl enable kubelet &amp;&amp; systemctl start kubelet
</code></pre>

<h3 id="创建-master-节点">创建 master 节点</h3>

<pre><code class="language-shell"># pod-network-cidr 10.244.0.0/16 是后面 flannel 默认配置的 pod Network，配置成这个地址不用改的flannel的 默认配置
kubeadm init --pod-network-cidr 10.244.0.0/16
</code></pre>

<p>成功执行后 master 节点就已经启动了, 可以选择安装一种网络插件，这里选择flannel</p>

<pre><code class="language-shell"># 使用默认配置启动 flannel 的 DaemonSet
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre>

<h3 id="创建-node-节点">创建 node 节点</h3>

<p>在 master 节点执行下面命令生成创建子节点命令</p>

<pre><code class="language-shell">kubeadm token create --print-join-command
</code></pre>

<pre><code class="language-shell">[root@localhost ~]$ kubeadm token create --print-join-command
kubeadm join masterip:6443 --token 5zk5ql.5eq0rgoui0dl0xx3 --discovery-token-ca-cert-hash sha256:5bef3894fc492bf9d93c9f248f84ec3sdsadasdss7685191a9d841fd32a88bb9ac9 
</code></pre>

<p>在 node 节点执行上述命令生成的命令</p>

<pre><code class="language-shell">kubeadm join masterip:6443 --token 5zk5ql.5eq0rgoui0dl0xx3 --discovery-token-ca-cert-hash sha256:5bef3894fc492bf9d93c9f248f84ec3sdsadasdss7685191a9d841fd32a88bb9ac9
</code></pre>

<p>执行成功则 node 节点添加成功</p>

<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1550631170"></script>
    <script src="/js/perfect-scrollbar.min.js?1550631170"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1550631170"></script>
    <script src="/js/jquery.sticky.js?1550631170"></script>
    <script src="/js/featherlight.min.js?1550631170"></script>
    <script src="/js/html5shiv-printshiv.min.js?1550631170"></script>
    <script src="/js/highlight.pack.js?1550631170"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js?1550631170"></script>
    <script src="/js/learn.js?1550631170"></script>
    <script src="/js/hugo-learn.js?1550631170"></script>

    <link href="/mermaid/mermaid.css?1550631170" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1550631170"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

