<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.51" />
    <meta name="description" content="for learning">
<meta name="author" content="maoqide">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/images/favicon.png" type="image/x-icon" />
    <title>Building an Operator for Kubernetes With the Sample Controller :: Maoqide</title>

    
    <link href="/css/nucleus.css?1558006997" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1558006997" rel="stylesheet">
    <link href="/css/hybrid.css?1558006997" rel="stylesheet">
    <link href="/css/featherlight.min.css?1558006997" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1558006997" rel="stylesheet">
    <link href="/css/auto-complete.css?1558006997" rel="stylesheet">
    <link href="/css/theme.css?1558006997" rel="stylesheet">
    <link href="/css/hugo-theme.css?1558006997" rel="stylesheet">
    
    
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?c3c6dd2eb79bc741d95463b6040ac868";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
    <script src="/js/jquery-2.x.min.js?1558006997"></script>

    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/cloud/building-an-operator-for-kubernetes-with-the-sample-controller/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="">
  <svg  width="100%" height="100%" viewBox="0 0 504 140" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <text x="30" y="110" fill="#F1F4F5" font-weight="bold" font-family="'Courier New', Courier, monospace" font-size="80">Maoqide</text>

    
  </svg>
</a>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-close"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1558006997"></script>
<script type="text/javascript" src="/js/auto-complete.js?1558006997"></script>
<script type="text/javascript">
    
        var baseurl = "";
    
</script>
<script type="text/javascript" src="/js/search.js?1558006997"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/golang/" title="Golang" class="dd-item 
        
        
        
        ">
      <a href="/golang/">
          Golang
          
            <i class="fas read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/golang/golang-mutex/" title="Golang Mutex" class="dd-item ">
        <a href="/golang/golang-mutex/">
        Golang Mutex
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/golang/goroutine/" title="Goroutine 的管理" class="dd-item ">
        <a href="/golang/goroutine/">
        Goroutine 的管理
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/collection/" title="Collection" class="dd-item 
        
        
        
        ">
      <a href="/collection/">
          Collection
          
            <i class="fas read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/collection/collection-2/" title="Collection 2" class="dd-item ">
        <a href="/collection/collection-2/">
        Collection 2
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/collection/collection-1/" title="Collection 1" class="dd-item ">
        <a href="/collection/collection-1/">
        Collection 1
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/algorithm/" title="Algorithm" class="dd-item 
        
        
        
        ">
      <a href="/algorithm/">
          Algorithm
          
            <i class="fas read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/algorithm/basic-data-structure/" title="Basic Data Structure" class="dd-item 
        
        
        
        ">
      <a href="/algorithm/basic-data-structure/">
          Basic Data Structure
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/cloud/" title="Cloud" class="dd-item 
        parent
        
        
        ">
      <a href="/cloud/">
          Cloud
          
            <i class="fas read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/cloud/sample-controller/" title="Sample Controller" class="dd-item 
        
        
        
        ">
      <a href="/cloud/sample-controller/">
          Sample Controller
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/cloud/building-an-operator-for-kubernetes-with-the-sample-controller/" title="Building an Operator for Kubernetes With the Sample Controller" class="dd-item active">
        <a href="/cloud/building-an-operator-for-kubernetes-with-the-sample-controller/">
        Building an Operator for Kubernetes With the Sample Controller
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/cloud/kube-scheduler-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" title="Kube Scheduler 源码阅读" class="dd-item ">
        <a href="/cloud/kube-scheduler-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">
        Kube Scheduler 源码阅读
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/cloud/container-network/" title="Container Network" class="dd-item 
        
        
        
        ">
      <a href="/cloud/container-network/">
          Container Network
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/cloud/docker-%E5%8E%9F%E7%90%86/" title="Docker 原理" class="dd-item 
        
        
        
        ">
      <a href="/cloud/docker-%E5%8E%9F%E7%90%86/">
          Docker 原理
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/cloud/controller-manager-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" title="Controller Manager 源码阅读" class="dd-item ">
        <a href="/cloud/controller-manager-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">
        Controller Manager 源码阅读
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/cloud/apiserver-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" title="Apiserver 源码阅读" class="dd-item ">
        <a href="/cloud/apiserver-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">
        Apiserver 源码阅读
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/cloud/kubelet/" title="Kubelet" class="dd-item 
        
        
        
        ">
      <a href="/cloud/kubelet/">
          Kubelet
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/cloud/%E9%98%BF%E9%87%8C%E4%BA%91%E4%B8%BB%E6%9C%BA%E6%90%AD%E5%BB%BA-k8s-%E9%9B%86%E7%BE%A4/" title="阿里云主机搭建 K8S 集群" class="dd-item ">
        <a href="/cloud/%E9%98%BF%E9%87%8C%E4%BA%91%E4%B8%BB%E6%9C%BA%E6%90%AD%E5%BB%BA-k8s-%E9%9B%86%E7%BE%A4/">
        阿里云主机搭建 K8S 集群
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/notes/" title="Notes" class="dd-item 
        
        
        
        ">
      <a href="/notes/">
          Notes
          
            <i class="fas read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/notes/publish-your-site-on-k8s/" title="将网站部署在 Kubernetes 上" class="dd-item 
        
        
        
        ">
      <a href="/notes/publish-your-site-on-k8s/">
          将网站部署在 Kubernetes 上
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/notes/build-blog-with-hugo/" title="Build Blog With Hugo" class="dd-item ">
        <a href="/notes/build-blog-with-hugo/">
        Build Blog With Hugo
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/contact/" title="Contact" class="dd-item 
        
        
        
        ">
      <a href="/contact/">
          Contact
          
            <i class="fas read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3></h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://github.com/maoqide"><i class='fab fa-github'></i> Github</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="http://getgrav.org">Grav</a> and <a href="http://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                   Building an Operator for Kubernetes With the Sample Controller 
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#the-sample-controller">The sample-controller</a></li>
<li><a href="#adapting-the-sample-controller">Adapting the sample-controller</a></li>
<li><a href="#deploying-the-operator-to-the-kubernetes-cluster">Deploying the operator to the Kubernetes cluster</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>Building an Operator for Kubernetes With the Sample Controller</h1>
          

        




<pre><code>An Operator is an application-specific controller that extends the Kubernetes API to create, configure, and manage instances of complex stateful applications on behalf of a Kubernetes user.     
</code></pre>

<p>Operator 是一个特定的应用程序的控制器，通过扩展 Kubernetes API 以代表 Kubernetes 用户创建，配置和管理复杂有状态应用程序的实例。<br />
Operator 是一种软件，它结合了特定的领域知识并通过 CRD(Custom Resource Definition ) 机制扩展了Kubernetes API，使用户像管理 Kubernetes 的内置资源一样创建，配置和管理应用程序。Operator 管理整个集群中的多个实例，而不仅仅管理应用程序的单个实例。</p>

<p>[译] <a href="https://itnext.io/building-an-operator-for-kubernetes-with-the-sample-controller-b4204be9ad56">https://itnext.io/building-an-operator-for-kubernetes-with-the-sample-controller-b4204be9ad56</a></p>

<h2 id="the-sample-controller">The sample-controller</h2>

<p>创建示例的 operator 程序需要用到的第一个工具是 <a href="https://github.com/kubernetes/sample-controller">sample-controller</a>, 可以在 <a href="https://github.com/kubernetes/sample-controller">https://github.com/kubernetes/sample-controller</a> 找到。</p>

<p>这个项目实现了一个简单的 <code>Foo</code> 类型的 operator, 当创建一个自定义类型的对象 <code>foo</code>，operator 会创建一个 以几个公开的 docker 镜像和特定的副本数创建一个 <code>Deployment</code>。<br />
要安装和编译它，需要确认你的 <code>GOPATH</code>，然后执行:</p>

<pre><code class="language-shell">go get github.com/kubernetes/sample-controller
cd $GOPATH/src/k8s.io/sample-controller
go build -o ctrl .
</code></pre>

<p>接着我们可以用<code>artifacts/examples</code>目录下的文件，创建<code>Foo</code>类型的自定义资源定义(CRD)。</p>

<pre><code class="language-shell">kubectl apply -f artifacts/examples/crd-validation.yaml
</code></pre>

<p>现在从另一个终端，我们可以操作<code>Foo</code>对象并观察 controller 发生了什么：</p>

<pre><code class="language-shell">$ kubectl apply -f artifacts/examples/example-foo.yaml
$ kubectl get pods
NAME                           READY  STATUS    RESTARTS   AGE
example-foo-6cbc69bf5d-j8lhx   1/1    Running   0          18s
$ kubectl delete -f artifacts/examples/example-foo.yaml
$ kubectl get pods
NAME                           READY  STATUS        RESTARTS   AGE
example-foo-6cbc69bf5d-j8lhx   0/1    Terminating   0          38s
</code></pre>

<pre><code>在 Kubernetes 1.11.0，controller 会进入无限循环，当 foo 对象创建一个 deployment 后更新它的状态：在`updateFooStatus`方法中，你必调用`UpdateStatus(fooCopy)`代替`Update(fooCopy)`。    
</code></pre>

<p>到目前为止，控制器完成了这样一项工作：它在我们创建<code>foo</code>对象时创建一个<code>deployment</code>并在我们删除对象时停止<code>deployment</code>。</p>

<p>现在我们可以进一步调整 CRD 和 controller 以使用我们自己的自定义资源定义。</p>

<h2 id="adapting-the-sample-controller">Adapting the sample-controller</h2>

<p>假设我们的目标是编写一个在集群节点上部署守护程序的 operator。它会使用 DaemonSet 对象来部署此守护程序，并且能够指定标签，仅在打上此标签的节点上部署守护程序。我们，还希望能够指定部署的 docker 镜像，而不是像<code>sample-controller</code>的例子那样静态的。</p>

<p>我们首先为<code>GenericDaemon</code>类型创建自定义资源定义：</p>

<pre><code class="language-yaml">// artifacts/generic-daemon/crd.yaml
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: genericdaemons.mydomain.com
spec:
  group: mydomain.com
  version: v1beta1
  names:
    kind: Genericdaemon
    plural: genericdaemons
  scope: Namespaced
  validation:
    openAPIV3Schema:
      properties:
        spec:
          properties:
            label:
              type: string
            image:
              type: string
          required:
            - image
</code></pre>

<p>以及第一个要部署的守护程序的示例：</p>

<pre><code class="language-yaml">// artifacts/generic-daemon/syslog.yaml
apiVersion: mydomain.com/v1beta1
kind: Genericdaemon
metadata:
  name: syslog
spec:
  label: logs
  image: mbessler/syslogdocker
</code></pre>

<p>现在我们必须为 operator 访问新的自定义资源定义(CRD)的 API 构建 go 文件。为此，我们要创建一个新的目录<code>pkg/apis/genericdaemon</code>，在这个目录中复制<code>pkg/apis/samplecontroller</code>目录下的文件(除了<code>zz_generated.deepcopy.go</code>)。</p>

<pre><code class="language-shell">$ tree pkg/apis/genericdaemon/
pkg/apis/genericdaemon/
├── register.go
└── v1beta1
    ├── doc.go
    ├── register.go
    └── types.go
</code></pre>

<p>并调整其内容：</p>

<pre><code class="language-golang">////////////////
// register.go
////////////////
package genericdaemon
const (
 GroupName = &quot;mydomain.com&quot;
)
/////////////////////
// v1beta1/doc.go
/////////////////////
// +k8s:deepcopy-gen=package
// Package v1beta1 is the v1beta1 version of the API.
// +groupName=mydomain.com
package v1beta1
/////////////////////////
// v1beta1/register.go
/////////////////////////
package v1beta1
import (
 metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;
 &quot;k8s.io/apimachinery/pkg/runtime&quot;
 &quot;k8s.io/apimachinery/pkg/runtime/schema&quot;
genericdaemon &quot;k8s.io/sample-controller/pkg/apis/genericdaemon&quot;
)
// SchemeGroupVersion is group version used to register these objects
var SchemeGroupVersion = schema.GroupVersion{Group: genericdaemon.GroupName, Version: &quot;v1beta1&quot;}
// Kind takes an unqualified kind and returns back a Group qualified GroupKind
func Kind(kind string) schema.GroupKind {
 return SchemeGroupVersion.WithKind(kind).GroupKind()
}
// Resource takes an unqualified resource and returns a Group qualified GroupResource
func Resource(resource string) schema.GroupResource {
 return SchemeGroupVersion.WithResource(resource).GroupResource()
}
var (
 SchemeBuilder = runtime.NewSchemeBuilder(addKnownTypes)
 AddToScheme   = SchemeBuilder.AddToScheme
)
// Adds the list of known types to Scheme.
func addKnownTypes(scheme *runtime.Scheme) error {
 scheme.AddKnownTypes(SchemeGroupVersion,
  &amp;Genericdaemon{},
  &amp;GenericdaemonList{},
 )
 metav1.AddToGroupVersion(scheme, SchemeGroupVersion)
 return nil
}
//////////////////////
// v1beta1/types.go
//////////////////////
package v1beta1
import (
 metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;
)
// +genclient
// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
// Genericdaemon is a specification for a Generic Daemon resource
type Genericdaemon struct {
 metav1.TypeMeta   `json:&quot;,inline&quot;`
 metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;`
 Spec   GenericdaemonSpec   `json:&quot;spec&quot;`
 Status GenericdaemonStatus `json:&quot;status&quot;`
}
// GenericDaemonSpec is the spec for a GenericDaemon resource
type GenericdaemonSpec struct {
 Label string `json:&quot;label&quot;`
 Image string `json:&quot;image&quot;`
}
// GenericDaemonStatus is the status for a GenericDaemon resource
type GenericdaemonStatus struct {
 Installed int32 `json:&quot;installed&quot;`
}
// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
// GenericDaemonList is a list of GenericDaemon resources
type GenericdaemonList struct {
 metav1.TypeMeta `json:&quot;,inline&quot;`
 metav1.ListMeta `json:&quot;metadata&quot;`
Items []Genericdaemon `json:&quot;items&quot;`
}
</code></pre>

<p>脚本<code>hack/update-codegen.sh</code>可用于生成我们之前文件中定义的新的自定义资源定义(CRD)的代码，我们必需修改此脚本来为我们的新 CRD 生成文件：</p>

<pre><code class="language-shell"># hack/update-codegen.sh
#!/usr/bin/env bash
set -o errexit
set -o nounset
set -o pipefail
SCRIPT_ROOT=$(dirname ${BASH_SOURCE})/..
CODEGEN_PKG=${CODEGEN_PKG:-$(cd ${SCRIPT_ROOT}; ls -d -1 ./vendor/k8s.io/code-generator 2&gt;/dev/null || echo ../code-generator)}
# generate the code with:
# --output-base    because this script should also be able to run inside the vendor dir of
#                  k8s.io/kubernetes. The output-base is needed for the generators to output into the vendor dir
#                  instead of the $GOPATH directly. For normal projects this can be dropped.
${CODEGEN_PKG}/generate-groups.sh &quot;deepcopy,client,informer,lister&quot; \
  k8s.io/sample-controller/pkg/client k8s.io/sample-controller/pkg/apis \
  genericdaemon:v1beta1 \
  --output-base &quot;$(dirname ${BASH_SOURCE})/../../..&quot; \
  --go-header-file ${SCRIPT_ROOT}/hack/boilerplate.go.txt
</code></pre>

<p>接着执行此脚本：</p>

<pre><code class="language-shell">$ ./hack/update-codegen.sh 
Generating deepcopy funcs
Generating clientset for genericdaemon:v1beta1 at k8s.io/sample-controller/pkg/client/clientset
Generating listers for genericdaemon:v1beta1 at k8s.io/sample-controller/pkg/client/listers
Generating informers for genericdaemon:v1beta1 at k8s.io/sample-controller/pkg/client/informers
</code></pre>

<p>现在可以调整它来编写我们的 operator。首先，我们必须将所有对之前的<code>Foo</code>类型的引用修改为<code>Genericdaemon</code>类型。另外，当一个新的 <code>genericdaemon</code>实例创建后，我们要创建 DaemonSet 而不是 Deployment。</p>

<h2 id="deploying-the-operator-to-the-kubernetes-cluster">Deploying the operator to the Kubernetes cluster</h2>

<p>当我们将<code>sample-controller</code>修改为我们需要的之后，我们要将它部署到kubernetes集群。事实上，在这个时候，我们已经使用我们的凭证将它运行在我们的开发系统来测试它。</p>

<p>这是一个简单的 Dockerfile，用于构建 operator 的 Docker 镜像（你必须删除原有的<code>sample-controller</code>中的所有代码才能构建）：</p>

<pre><code class="language-Dockerfile">FROM golang
RUN mkdir -p /go/src/k8s.io/sample-controller
ADD . /go/src/k8s.io/sample-controller
WORKDIR /go
RUN go get ./...
RUN go install -v ./...
CMD [&quot;/go/bin/sample-controller&quot;]
</code></pre>

<p>现在我们可以构建并将镜像推送到 DockerHub：</p>

<pre><code class="language-shell">docker build . -t mydockerid/genericdaemon
docker push mydockerid/genericdaemon
</code></pre>

<p>最后用这个新的镜像部署一个 Deployment：</p>

<pre><code class="language-yaml">// deploy.yaml
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: sample-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sample
  template:
    metadata:
      labels:
        app: sample
    spec:
      containers:
      - name: sample
		image: &quot;mydockerid/genericdaemon:latest&quot;
</code></pre>

<p>并<code>kubectl apply -f deploy.yaml</code>。</p>

<p>operator 现在已经运行，但是如果我们查看 pod 的日志，可以看到授权存在问题; pod 没有对不同资源的访问权限：</p>

<pre><code>$ kubectl logs sample-controller-66b79c7d5f-2qnft
E0721 14:34:50.499584       1 reflector.go:134] k8s.io/sample-controller/pkg/client/informers/externalversions/factory.go:117: Failed to list *v1beta1.Genericdaemon: genericdaemons.mydomain.com is forbidden: User &quot;system:serviceaccount:default:default&quot; cannot list genericdaemons.mydomain.com at the cluster scope
E0721 14:34:50.500385       1 reflector.go:134] k8s.io/client-go/informers/factory.go:131: Failed to list *v1.DaemonSet: daemonsets.apps is forbidden: User &quot;system:serviceaccount:default:default&quot; cannot list daemonsets.apps at the cluster scope
[...]
</code></pre>

<p>我们需要创建一个<code>ClusterRole</code>和一个<code>ClusterRoleBinding</code>来为 operator 提供必要的权限：</p>

<pre><code class="language-yaml">// rbac_role.yaml
kind: ClusterRole
metadata:
  name: operator-role
rules:
- apiGroups:
  - apps
  resources:
  - daemonsets
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - mydomain.com
  resources:
  - genericdaemons
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
// rbac_role_binding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: operator-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: operator-role
subjects:
- kind: ServiceAccount
  name: default
  namespace: default
</code></pre>

<p>并且部署它：</p>

<pre><code class="language-shell">kubectl apply -f rbac_role.yaml
kubectl delete -f deploy.yaml
kubectl apply -f deploy.yaml
</code></pre>

<p>现在，你的 operator 应该已经部署到你的 Kubernetes 集群并处于活动状态。</p>


<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1558006997"></script>
    <script src="/js/perfect-scrollbar.min.js?1558006997"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1558006997"></script>
    <script src="/js/jquery.sticky.js?1558006997"></script>
    <script src="/js/featherlight.min.js?1558006997"></script>
    <script src="/js/html5shiv-printshiv.min.js?1558006997"></script>
    <script src="/js/highlight.pack.js?1558006997"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js?1558006997"></script>
    <script src="/js/learn.js?1558006997"></script>
    <script src="/js/hugo-learn.js?1558006997"></script>

    <link href="/mermaid/mermaid.css?1558006997" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1558006997"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

