<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8" />

  
  <title>Controller Manager 源码阅读</title>

  
  
  <link href="//cdn.jsdelivr.net" rel="dns-prefetch">
  <link href="//cdnjs.cloudflare.com" rel="dns-prefetch">
  
  <link href="//at.alicdn.com" rel="dns-prefetch">
  
  <link href="//fonts.googleapis.com" rel="dns-prefetch">
  <link href="//fonts.gstatic.com" rel="dns-prefetch">
  <link href="///disqus.com" rel="dns-prefetch">
  <link href="//c.disquscdn.com" rel="dns-prefetch">
  
  <link href="//www.google-analytics.com" rel="dns-prefetch">
  <link href="//hm.baidu.com" rel="dns-prefetch">

  

  
  <meta name="author" content="Maoqide">
  <meta name="description" content="k8s controller-manager 源码阅读笔记
">

  
  
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@gohugoio">
    <meta name="twitter:title" content="Controller Manager 源码阅读">
    <meta name="twitter:description" content="k8s controller-manager 源码阅读笔记
">
    <meta name="twitter:image" content="/images/golang.svg">
  

  
  <meta property="og:type" content="article">
  <meta property="og:title" content="Controller Manager 源码阅读">
  <meta property="og:description" content="k8s controller-manager 源码阅读笔记
">
  <meta property="og:url" content="maoqide.live/post/cloud/controller-manager-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">
  <meta property="og:image" content="/images/golang.svg">




<meta name="generator" content="Hugo 0.51">


<link rel="canonical" href="maoqide.live/post/cloud/controller-manager-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">

<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="format-detection" content="telephone=no,email=no,adress=no">
<meta http-equiv="Cache-Control" content="no-transform">


<meta name="robots" content="index,follow">
<meta name="referrer" content="origin-when-cross-origin">
<meta name="google-site-verification" content="moDctZ0TPe6VxisyOQD_1YWrlEXu3jHdB1go5ptHRn0">
<meta name="msvalidate.01" content="0498007A4CDA3EAB6CD23570479B29DA">





<meta name="theme-color" content="#02b875">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Maoqide">
<meta name="msapplication-tooltip" content="Maoqide">
<meta name='msapplication-navbutton-color' content="#02b875">
<meta name="msapplication-TileColor" content="#02b875">
<meta name="msapplication-TileImage" content="/icons/icon-144x144.png">
<link rel="icon" href="maoqide.live/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="maoqide.live/icons/icon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="maoqide.live/icons/icon-32x32.png">
<link rel="icon" sizes="192x192" href="maoqide.live/icons/icon-192x192.png">
<link rel="apple-touch-icon" href="maoqide.live/icons/icon-152x152.png">
<link rel="manifest" href="maoqide.live/manifest.json">


<link rel="preload" href="maoqide.live/styles/main-rendered.min.css" as="style">


<link rel="preload" href="https://fonts.googleapis.com/css?family=Lobster" as="style">
<link rel="preload" href="maoqide.live/images/golang.svg" as="image">
<link rel="preload" href="maoqide.live/images/square.svg" as="image">


<style>
  body {
    background: rgb(244, 243, 241) url('/images/square.svg') repeat fixed;
  }
</style>
<link rel="stylesheet" href="maoqide.live/styles/main-rendered.min.css">


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lobster">



<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.2/dist/medium-zoom.min.js"></script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video-js.min.css">



  
  
<!--[if lte IE 8]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-ie8@1.1.2/dist/videojs-ie8.min.js"></script>
<![endif]-->

<!--[if lte IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/eligrey-classlist-js-polyfill@1.2.20180112/classList.min.js"></script>
<![endif]-->


</head>
  <body>
    <div class="suspension">
      <a role="button" aria-label="Go to top" title="Go to top" class="to-top is-hide"><span class="icon icon-up" aria-hidden="true"></span></a>
      
        
	<a role="button" aria-label="Go to comments" title="Go to comments" class="to-comment" href="#disqus_thread"><span class="icon icon-comment" aria-hidden="true"></span></a>
        
      
    </div>
    
    
  <header class="site-header">
  <a href="maoqide.live"><img class="avatar" src="maoqide.live/images/golang.svg" alt="Avatar"></a>
  
  <h2 class="title"><a href="maoqide.live">Maoqide</a></h2>
  
  <p class="subtitle">~ Keep Learning ~</p>
  <button class="menu-toggle" type="button" aria-label="Main Menu" aria-expanded="false" tab-index="0">
    <span class="icon icon-menu" aria-hidden="true"></span>
  </button>

  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item
          
          
           is-active">
          <a href="maoqide.live/">Home</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="maoqide.live/post/">Post</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="maoqide.live/tags/">Tags</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="maoqide.live/about/">About</a>
        </li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list"><li class="social-item">
          <a href="mailto:maoqidemail@gmail.com" title="Email" aria-label="Email">
            <span class="icon icon-email" aria-hidden="true"></span>
          </a>
        </li><li class="social-item">
          <a href="//github.com/maoqide" rel="me" title="GitHub" aria-label="GitHub">
	    <span class="icon icon-github" aria-hidden="true"></span>
          </a>
        </li></ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">Controller Manager 源码阅读</h1>
      <p class="post-meta">@Maoqide · Feb 23, 2019 · 6 min read</p>
    </header>
    <article class="post-content"><p>k8s controller-manager 源码阅读笔记</p>

<h2 id="代码结构">代码结构</h2>

<pre><code>本部分用于记录 kube-controller-manager 代码整体结构及关键方法，便于到源码中查找，个人阅读记录，读者可跳过。本文所有代码均基于 kubernetes release-1.13。        
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// cmd/kube-controller-manager/controller-manager.go
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">main</span>()
		<span style="color:#a6e22e">command</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">NewControllerManagerCommand</span>()

<span style="color:#75715e">// cmd/kube-controller-manager/app/controllermanager.go
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">NewControllerManagerCommand</span>()
		<span style="color:#75715e">/*
</span><span style="color:#75715e">		**	指定 port，所有默认 port 在 pkg/master/ports/ports.go 这个文件中
</span><span style="color:#75715e">		**	将默认配置传入 Options，设置每个 controller 基础配置（证书，同步间隔...）
</span><span style="color:#75715e">		**	设置 gcIgnoredResources
</span><span style="color:#75715e">		**	var ignoredResources = map[schema.GroupResource]struct{}{
</span><span style="color:#75715e">		**		{Group: &#34;&#34;, Resource: &#34;events&#34;}: {},
</span><span style="color:#75715e">		**	}
</span><span style="color:#75715e">		*/</span>
		<span style="color:#a6e22e">NewKubeControllerManagerOptions</span>()		<span style="color:#75715e">// creates a new KubeControllerManagerOptions with a default config.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cobra</span>.<span style="color:#a6e22e">Command</span>{
			<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
			<span style="color:#a6e22e">Run</span>: <span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">cobra</span>.<span style="color:#a6e22e">Command</span>, <span style="color:#a6e22e">args</span> []<span style="color:#66d9ef">string</span>) {}
				<span style="color:#75715e">//...
</span><span style="color:#75715e"></span>
				<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Config</span>(<span style="color:#a6e22e">KnownControllers</span>(), <span style="color:#a6e22e">ControllersDisabledByDefault</span>.<span style="color:#a6e22e">List</span>())
				<span style="color:#75715e">// ControllersDisabledByDefault = sets.NewString(&#34;bootstrapsigner&#34;, &#34;tokencleaner&#34;,)
</span><span style="color:#75715e"></span>					<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Validate</span>(<span style="color:#a6e22e">allControllers</span>, <span style="color:#a6e22e">disabledByDefaultControllers</span>)	<span style="color:#75715e">// validate all controllers options and config
</span><span style="color:#75715e"></span>					<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientset</span>.<span style="color:#a6e22e">NewForConfig</span>(<span style="color:#a6e22e">restclient</span>.<span style="color:#a6e22e">AddUserAgent</span>(<span style="color:#a6e22e">kubeconfig</span>, <span style="color:#a6e22e">KubeControllerManagerUserAgent</span>))
					<span style="color:#a6e22e">leaderElectionClient</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientset</span>.<span style="color:#a6e22e">NewForConfigOrDie</span>(<span style="color:#a6e22e">restclient</span>.<span style="color:#a6e22e">AddUserAgent</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">config</span>, <span style="color:#e6db74">&#34;leader-election&#34;</span>))
					<span style="color:#75715e">// an EventRecorder can be used to send events to this EventBroadcaster
</span><span style="color:#75715e"></span>					<span style="color:#75715e">// with the event source set to the given event source.
</span><span style="color:#75715e"></span>					<span style="color:#a6e22e">eventRecorder</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">createRecorder</span>(<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">KubeControllerManagerUserAgent</span>)
						<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">createRecorder</span>(<span style="color:#a6e22e">kubeClient</span> <span style="color:#a6e22e">clientset</span>.<span style="color:#a6e22e">Interface</span>, <span style="color:#a6e22e">userAgent</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">record</span>.<span style="color:#a6e22e">EventRecorder</span> {}
							<span style="color:#a6e22e">eventBroadcaster</span>.<span style="color:#a6e22e">StartRecordingToSink</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1core</span>.<span style="color:#a6e22e">EventSinkImpl</span>{<span style="color:#a6e22e">Interface</span>: <span style="color:#a6e22e">kubeClient</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Events</span>(<span style="color:#e6db74">&#34;&#34;</span>)})
							<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">eventBroadcaster</span>.<span style="color:#a6e22e">NewRecorder</span>(<span style="color:#a6e22e">clientgokubescheme</span>.<span style="color:#a6e22e">Scheme</span>, <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">EventSource</span>{<span style="color:#a6e22e">Component</span>: <span style="color:#a6e22e">userAgent</span>})
					<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">kubecontrollerconfig</span>.<span style="color:#a6e22e">Config</span>{
						<span style="color:#a6e22e">Client</span>:               <span style="color:#a6e22e">client</span>,
						<span style="color:#a6e22e">Kubeconfig</span>:           <span style="color:#a6e22e">kubeconfig</span>,
						<span style="color:#a6e22e">EventRecorder</span>:        <span style="color:#a6e22e">eventRecorder</span>,
						<span style="color:#a6e22e">LeaderElectionClient</span>: <span style="color:#a6e22e">leaderElectionClient</span>,
					}				
				<span style="color:#a6e22e">KnownControllers</span>()
					<span style="color:#75715e">// NewControllerInitializers is a public map of named controller groups (you can start more than one in an init func)
</span><span style="color:#75715e"></span>					<span style="color:#75715e">// paired to their InitFunc. 
</span><span style="color:#75715e"></span>					<span style="color:#a6e22e">NewControllerInitializers</span>(<span style="color:#a6e22e">loopMode</span> <span style="color:#a6e22e">ControllerLoopMode</span>) <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">InitFunc</span> {}
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;endpoint&#34;</span>] = <span style="color:#a6e22e">startEndpointController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;replicationcontroller&#34;</span>] = <span style="color:#a6e22e">startReplicationController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;podgc&#34;</span>] = <span style="color:#a6e22e">startPodGCController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;resourcequota&#34;</span>] = <span style="color:#a6e22e">startResourceQuotaController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;namespace&#34;</span>] = <span style="color:#a6e22e">startNamespaceController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;serviceaccount&#34;</span>] = <span style="color:#a6e22e">startServiceAccountController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;garbagecollector&#34;</span>] = <span style="color:#a6e22e">startGarbageCollectorController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;daemonset&#34;</span>] = <span style="color:#a6e22e">startDaemonSetController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;job&#34;</span>] = <span style="color:#a6e22e">startJobController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;deployment&#34;</span>] = <span style="color:#a6e22e">startDeploymentController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;replicaset&#34;</span>] = <span style="color:#a6e22e">startReplicaSetController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;horizontalpodautoscaling&#34;</span>] = <span style="color:#a6e22e">startHPAController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;disruption&#34;</span>] = <span style="color:#a6e22e">startDisruptionController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;statefulset&#34;</span>] = <span style="color:#a6e22e">startStatefulSetController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;cronjob&#34;</span>] = <span style="color:#a6e22e">startCronJobController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;csrsigning&#34;</span>] = <span style="color:#a6e22e">startCSRSigningController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;csrapproving&#34;</span>] = <span style="color:#a6e22e">startCSRApprovingController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;csrcleaner&#34;</span>] = <span style="color:#a6e22e">startCSRCleanerController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;ttl&#34;</span>] = <span style="color:#a6e22e">startTTLController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;bootstrapsigner&#34;</span>] = <span style="color:#a6e22e">startBootstrapSignerController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;tokencleaner&#34;</span>] = <span style="color:#a6e22e">startTokenCleanerController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;nodeipam&#34;</span>] = <span style="color:#a6e22e">startNodeIpamController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;nodelifecycle&#34;</span>] = <span style="color:#a6e22e">startNodeLifecycleController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;persistentvolume-binder&#34;</span>] = <span style="color:#a6e22e">startPersistentVolumeBinderController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;attachdetach&#34;</span>] = <span style="color:#a6e22e">startAttachDetachController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;persistentvolume-expander&#34;</span>] = <span style="color:#a6e22e">startVolumeExpandController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;clusterrole-aggregation&#34;</span>] = <span style="color:#a6e22e">startClusterRoleAggregrationController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;pvc-protection&#34;</span>] = <span style="color:#a6e22e">startPVCProtectionController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;pv-protection&#34;</span>] = <span style="color:#a6e22e">startPVProtectionController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;ttl-after-finished&#34;</span>] = <span style="color:#a6e22e">startTTLAfterFinishedController</span>
						<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;root-ca-cert-publisher&#34;</span>] = <span style="color:#a6e22e">startRootCACertPublisher</span>
				<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Complete</span>(), <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">NeverStop</span>)
					<span style="color:#a6e22e">configz</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">ConfigzName</span>)	<span style="color:#75715e">// ConfigzName=&#34;kubecontrollermanager.config.k8s.io&#34;
</span><span style="color:#75715e"></span>					<span style="color:#75715e">// Start the controller manager HTTP server. insecure as example.
</span><span style="color:#75715e"></span>					<span style="color:#a6e22e">unsecuredMux</span> = <span style="color:#a6e22e">genericcontrollermanager</span>.<span style="color:#a6e22e">NewBaseHandler</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ComponentConfig</span>.<span style="color:#a6e22e">Generic</span>.<span style="color:#a6e22e">Debugging</span>, <span style="color:#a6e22e">checks</span><span style="color:#f92672">...</span>)
					<span style="color:#a6e22e">insecureSuperuserAuthn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">AuthenticationInfo</span>{<span style="color:#a6e22e">Authenticator</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">InsecureSuperuser</span>{}}
					<span style="color:#a6e22e">handler</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">genericcontrollermanager</span>.<span style="color:#a6e22e">BuildHandlerChain</span>(<span style="color:#a6e22e">unsecuredMux</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">insecureSuperuserAuthn</span>)
					<span style="color:#a6e22e">InsecureServing</span>.<span style="color:#a6e22e">Serve</span>(<span style="color:#a6e22e">handler</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">stopCh</span>)
						<span style="color:#a6e22e">RunServer</span>(<span style="color:#a6e22e">insecureServer</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Listener</span>, <span style="color:#a6e22e">shutdownTimeout</span>, <span style="color:#a6e22e">stopCh</span>)
					<span style="color:#a6e22e">run</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) {}
						<span style="color:#a6e22e">rootClientBuilder</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">SimpleControllerClientBuilder</span>{
							<span style="color:#a6e22e">ClientConfig</span>: <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Kubeconfig</span>,
						}
						<span style="color:#a6e22e">controllerContext</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateControllerContext</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">rootClientBuilder</span>, <span style="color:#a6e22e">clientBuilder</span>, <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>())
						<span style="color:#75715e">// CreateControllerContext creates a context struct containing references to resources needed by the
</span><span style="color:#75715e"></span>						<span style="color:#75715e">// controllers such as the cloud provider and clientBuilder. rootClientBuilder is only used for
</span><span style="color:#75715e"></span>						<span style="color:#75715e">// the shared-informers client and token controller.
</span><span style="color:#75715e"></span>						<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CreateControllerContext</span>(<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">CompletedConfig</span>, <span style="color:#a6e22e">rootClientBuilder</span>, <span style="color:#a6e22e">clientBuilder</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">ControllerClientBuilder</span>, <span style="color:#a6e22e">stop</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) (<span style="color:#a6e22e">ControllerContext</span>, <span style="color:#66d9ef">error</span>) {}
							<span style="color:#a6e22e">versionedClient</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rootClientBuilder</span>.<span style="color:#a6e22e">ClientOrDie</span>(<span style="color:#e6db74">&#34;shared-informers&#34;</span>)
							<span style="color:#a6e22e">sharedInformers</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">informers</span>.<span style="color:#a6e22e">NewSharedInformerFactory</span>(<span style="color:#a6e22e">versionedClient</span>, <span style="color:#a6e22e">ResyncPeriod</span>(<span style="color:#a6e22e">s</span>)())
							
							<span style="color:#75715e">// If apiserver is not running we should wait for some time and fail only then. This is particularly
</span><span style="color:#75715e"></span>							<span style="color:#75715e">// important when we start apiserver and controller manager at the same time.
</span><span style="color:#75715e"></span>							<span style="color:#a6e22e">genericcontrollermanager</span>.<span style="color:#a6e22e">WaitForAPIServer</span>(<span style="color:#a6e22e">versionedClient</span>, <span style="color:#ae81ff">10</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
							<span style="color:#75715e">// returns the supported resources for all groups and versions, by request &#34;/apis/.......&#34;
</span><span style="color:#75715e"></span>							<span style="color:#a6e22e">availableResources</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">GetAvailableResources</span>(<span style="color:#a6e22e">rootClientBuilder</span>)
							<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ControllerContext</span>{
								<span style="color:#a6e22e">ClientBuilder</span>:      <span style="color:#a6e22e">clientBuilder</span>,
								<span style="color:#a6e22e">InformerFactory</span>:    <span style="color:#a6e22e">sharedInformers</span>,
								<span style="color:#a6e22e">ComponentConfig</span>:    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ComponentConfig</span>,
								<span style="color:#a6e22e">RESTMapper</span>:         <span style="color:#a6e22e">restMapper</span>,
								<span style="color:#a6e22e">AvailableResources</span>: <span style="color:#a6e22e">availableResources</span>,
								<span style="color:#a6e22e">Cloud</span>:              <span style="color:#a6e22e">cloud</span>,
								<span style="color:#a6e22e">LoopMode</span>:           <span style="color:#a6e22e">loopMode</span>,
								<span style="color:#a6e22e">Stop</span>:               <span style="color:#a6e22e">stop</span>,
								<span style="color:#a6e22e">InformersStarted</span>:   make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}),
								<span style="color:#a6e22e">ResyncPeriod</span>:       <span style="color:#a6e22e">ResyncPeriod</span>(<span style="color:#a6e22e">s</span>),
							}

						<span style="color:#75715e">// serviceAccountTokenControllerStarter is special because it must run first to set up permissions for other controllers.
</span><span style="color:#75715e"></span>						<span style="color:#75715e">// It cannot use the &#34;normal&#34; client builder, so it tracks its own. It must also avoid being included in the &#34;normal&#34;
</span><span style="color:#75715e"></span>						<span style="color:#75715e">// init map so that it can always run first.
</span><span style="color:#75715e"></span>						<span style="color:#a6e22e">saTokenControllerInitFunc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">serviceAccountTokenControllerStarter</span>{<span style="color:#a6e22e">rootClientBuilder</span>: <span style="color:#a6e22e">rootClientBuilder</span>}.<span style="color:#a6e22e">startServiceAccountTokenController</span>
						<span style="color:#a6e22e">startServiceAccountTokenController</span>() {}
							<span style="color:#75715e">// 获取相关证书
</span><span style="color:#75715e"></span>							<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
							<span style="color:#a6e22e">controller</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">serviceaccountcontroller</span>.<span style="color:#a6e22e">NewTokensController</span>(
								<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">InformerFactory</span>.<span style="color:#a6e22e">Core</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">ServiceAccounts</span>(),
								<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">InformerFactory</span>.<span style="color:#a6e22e">Core</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">Secrets</span>(),
								<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">rootClientBuilder</span>.<span style="color:#a6e22e">ClientOrDie</span>(<span style="color:#e6db74">&#34;tokens-controller&#34;</span>),
								<span style="color:#a6e22e">serviceaccountcontroller</span>.<span style="color:#a6e22e">TokensControllerOptions</span>{
									<span style="color:#a6e22e">TokenGenerator</span>: <span style="color:#a6e22e">tokenGenerator</span>,
									<span style="color:#a6e22e">RootCA</span>:         <span style="color:#a6e22e">rootCA</span>,
								},
							)
							<span style="color:#a6e22e">NewTokensController</span>() {}	<span style="color:#75715e">// watch queueServiceAccountSync event 和 queueSecretSync event
</span><span style="color:#75715e"></span>
						<span style="color:#a6e22e">StartControllers</span>(<span style="color:#a6e22e">controllerContext</span>, <span style="color:#a6e22e">saTokenControllerInitFunc</span>, <span style="color:#a6e22e">NewControllerInitializers</span>(<span style="color:#a6e22e">controllerContext</span>.<span style="color:#a6e22e">LoopMode</span>), <span style="color:#a6e22e">unsecuredMux</span>)
							<span style="color:#a6e22e">startSATokenController</span>(<span style="color:#a6e22e">ctx</span>)	<span style="color:#75715e">// 先启动 SATokenController
</span><span style="color:#75715e"></span>							<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">controllerName</span>, <span style="color:#a6e22e">initFn</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">controllers</span> {
								<span style="color:#a6e22e">IsControllerEnabled</span>	<span style="color:#75715e">// 判断是否启用 controller
</span><span style="color:#75715e"></span>								<span style="color:#75715e">// Jitter returns a time.Duration between duration and duration + maxFactor * duration.
</span><span style="color:#75715e"></span>								<span style="color:#75715e">// This allows clients to avoid converging on periodic behavior. If maxFactor
</span><span style="color:#75715e"></span>								<span style="color:#75715e">// is 0.0, a suggested default value will be chosen.
</span><span style="color:#75715e"></span>								<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Jitter</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">ComponentConfig</span>.<span style="color:#a6e22e">Generic</span>.<span style="color:#a6e22e">ControllerStartInterval</span>.<span style="color:#a6e22e">Duration</span>, <span style="color:#a6e22e">ControllerStartJitter</span>))
								<span style="color:#a6e22e">debugHandler</span>, <span style="color:#a6e22e">started</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">initFn</span>(<span style="color:#a6e22e">ctx</span>)
								<span style="color:#75715e">// 
</span><span style="color:#75715e"></span>								<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">debugHandler</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">unsecuredMux</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
									<span style="color:#a6e22e">basePath</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;/debug/controllers/&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">controllerName</span>
									<span style="color:#a6e22e">unsecuredMux</span>.<span style="color:#a6e22e">UnlistedHandle</span>(<span style="color:#a6e22e">basePath</span>, <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StripPrefix</span>(<span style="color:#a6e22e">basePath</span>, <span style="color:#a6e22e">debugHandler</span>))
									<span style="color:#a6e22e">unsecuredMux</span>.<span style="color:#a6e22e">UnlistedHandlePrefix</span>(<span style="color:#a6e22e">basePath</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StripPrefix</span>(<span style="color:#a6e22e">basePath</span>, <span style="color:#a6e22e">debugHandler</span>))
								}
							}
						<span style="color:#a6e22e">controllerContext</span>.<span style="color:#a6e22e">InformerFactory</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">controllerContext</span>.<span style="color:#a6e22e">Stop</span>)

						<span style="color:#75715e">// InformersStarted is closed after all of the controllers have been initialized and are running.  After this point it is safe,
</span><span style="color:#75715e"></span>						<span style="color:#75715e">// for an individual controller to start the shared informers. Before it is closed, they should not.
</span><span style="color:#75715e"></span>						close(<span style="color:#a6e22e">controllerContext</span>.<span style="color:#a6e22e">InformersStarted</span>)	<span style="color:#75715e">// !!!!!
</span><span style="color:#75715e"></span>				
					<span style="color:#75715e">// leader 选举，通过获取锁成为 leader
</span><span style="color:#75715e"></span>					<span style="color:#a6e22e">leaderelection</span>.<span style="color:#a6e22e">RunOrDie</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">leaderelection</span>.<span style="color:#a6e22e">LeaderElectionConfig</span>{
						<span style="color:#a6e22e">Lock</span>:          <span style="color:#a6e22e">rl</span>,
						<span style="color:#75715e">// ... ...
</span><span style="color:#75715e"></span>						<span style="color:#a6e22e">Callbacks</span>: <span style="color:#a6e22e">leaderelection</span>.<span style="color:#a6e22e">LeaderCallbacks</span>{
							<span style="color:#a6e22e">OnStartedLeading</span>: <span style="color:#a6e22e">run</span>,
							<span style="color:#a6e22e">OnStoppedLeading</span>: <span style="color:#66d9ef">func</span>() {
								<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;leaderelection lost&#34;</span>)
							},
						},
						<span style="color:#a6e22e">WatchDog</span>: <span style="color:#a6e22e">electionChecker</span>,
						<span style="color:#a6e22e">Name</span>:     <span style="color:#e6db74">&#34;kube-controller-manager&#34;</span>,
					})
		}</code></pre></div>
<h2 id="cmd-run">cmd.Run</h2>

<p>目前的 kubernetes 组件全都采用 <a href="https://github.com/spf13/cobra">cobra</a> 构建。核心的启动流程都在生成的 <code>cobra.Command</code> 实例 <code>cmd</code> 的 <code>Run()</code> 方法中。<br />
<code>Run</code> 方法执行了两个方法，<code>s.Config(KnownControllers(), ControllersDisabledByDefault.List())</code>, <code>Run(c.Complete(), wait.NeverStop)</code>。</p>

<h2 id="s-config-knowncontrollers-controllersdisabledbydefault-list">s.Config(KnownControllers(), ControllersDisabledByDefault.List())</h2>

<p><code>KnownControllers()</code> 方法调用了 <code>NewControllerInitializers()</code>, 生成一个 <code>map[string]InitFunc{}</code> 的map，保存了 controller 和对应的启动方法的映射。<code>s.Config</code> 方法返回了 controller-manager 的配置，首先对所有 controllers 进行 validate，然后会构建一个 k8s clientset 和 一个 <code>EventRecorder</code> 对象，具体事件记录的方式，会在后面分析。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// EventRecorder knows how to record events on behalf of an EventSource.
</span><span style="color:#75715e">// an EventRecorder can be used to send events to this EventBroadcaster
</span><span style="color:#75715e">// with the event source set to the given event source.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">EventRecorder</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">// Event constructs an event from the given information and puts it in the queue for sending.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// The resulting event will be created in the same namespace as the reference object.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Event</span>(<span style="color:#a6e22e">object</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Object</span>, <span style="color:#a6e22e">eventtype</span>, <span style="color:#a6e22e">reason</span>, <span style="color:#a6e22e">message</span> <span style="color:#66d9ef">string</span>)

	<span style="color:#75715e">// Eventf is just like Event, but with Sprintf for the message field.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Eventf</span>(<span style="color:#a6e22e">object</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Object</span>, <span style="color:#a6e22e">eventtype</span>, <span style="color:#a6e22e">reason</span>, <span style="color:#a6e22e">messageFmt</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">args</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">interface</span>{})

	<span style="color:#75715e">// PastEventf is just like Eventf, but with an option to specify the event&#39;s &#39;timestamp&#39; field.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PastEventf</span>(<span style="color:#a6e22e">object</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Object</span>, <span style="color:#a6e22e">timestamp</span> <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">Time</span>, <span style="color:#a6e22e">eventtype</span>, <span style="color:#a6e22e">reason</span>, <span style="color:#a6e22e">messageFmt</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">args</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">interface</span>{})

	<span style="color:#75715e">// AnnotatedEventf is just like eventf, but with annotations attached
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">AnnotatedEventf</span>(<span style="color:#a6e22e">object</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Object</span>, <span style="color:#a6e22e">annotations</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">eventtype</span>, <span style="color:#a6e22e">reason</span>, <span style="color:#a6e22e">messageFmt</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">args</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">interface</span>{})
}</code></pre></div>
<h2 id="run-c-complete-wait-neverstop">Run(c.Complete(), wait.NeverStop)</h2>

<p>首先<code>configz.New(ConfigzName)</code>生成 controller-manager 的配置对象，用名称<code>kubecontrollermanager.config.k8s.io</code>注册到注册到路由<code>/configz</code>上，可以直接通过 controller-manager 的地址访问到。接着，会新建一个 BaseHandler 实例并启动 HTTP server，用来注册 controller manager 的 <code>/metric</code> 和 <code>/healthz</code> 接口。接下来，定义了一个内部方法<code>run()</code>, 启动 controller-manager 的主要操作，都在这个方法中完成。<br />
<code>run()</code>方法首先创建一个<code>ControllerContext</code>, 结构体如下，主要包含 controllers 所需要资源的引用，如 kubernetes 的 clientset 和informer。AvailableResources 由<code>GetAvailableResources</code>方法获取，通过 apiserver 的<code>/api/...</code>接口获取集群支持的所有 group 和 version 资源。然后开始启动 controllers，在启动其他 controller 前，一定先启动 SATokenController，因为它必须先为其他 controller 创建所需的 token 授权，所以启动<code>SATokenController</code>的方法独立于启动其他 controller 的循环之外，作为最先启动的一个。<code>startServiceAccountTokenController</code> watch 了<code>ServiceAccount</code>和<code>secret</code>的增删改事件，并同步本地的 queue 缓存。接下来才会调用<code>StartControllers</code>方法依次调用其他 controller 的 <code>InitFunc</code> 启动 controllers。最后启动 <code>controllerContext</code> 的 InformerFactory 并执行<code>close(controllerContext.InformersStarted)</code>。这里的<code>controllerContext.InformersStarted</code>是<code>chan struct{}</code>类型，当这个 channel 被关闭了，代表所有 controllers 都被初始化并运行起来了，独立的 controller 应该在他关闭后再启动 sharedInformer。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ControllerContext</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// ClientBuilder will provide a client for this controller to use
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ClientBuilder</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">ControllerClientBuilder</span>

	<span style="color:#75715e">// InformerFactory gives access to informers for the controller.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">InformerFactory</span> <span style="color:#a6e22e">informers</span>.<span style="color:#a6e22e">SharedInformerFactory</span>

	<span style="color:#75715e">// ComponentConfig provides access to init options for a given controller
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ComponentConfig</span> <span style="color:#a6e22e">kubectrlmgrconfig</span>.<span style="color:#a6e22e">KubeControllerManagerConfiguration</span>

	<span style="color:#75715e">// DeferredDiscoveryRESTMapper is a RESTMapper that will defer
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// initialization of the RESTMapper until the first mapping is
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// requested.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">RESTMapper</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">restmapper</span>.<span style="color:#a6e22e">DeferredDiscoveryRESTMapper</span>

	<span style="color:#75715e">// AvailableResources is a map listing currently available resources
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">AvailableResources</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupVersionResource</span>]<span style="color:#66d9ef">bool</span>

	<span style="color:#75715e">// Cloud is the cloud provider interface for the controllers to use.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// It must be initialized and ready to use.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Cloud</span> <span style="color:#a6e22e">cloudprovider</span>.<span style="color:#a6e22e">Interface</span>

	<span style="color:#75715e">// Control for which control loops to be run
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// IncludeCloudLoops is for a kube-controller-manager running all loops
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// ExternalLoops is for a kube-controller-manager running with a cloud-controller-manager
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">LoopMode</span> <span style="color:#a6e22e">ControllerLoopMode</span>

	<span style="color:#75715e">// Stop is the stop channel
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Stop</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}

	<span style="color:#75715e">// InformersStarted is closed after all of the controllers have been initialized and are running.  After this point it is safe,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// for an individual controller to start the shared informers. Before it is closed, they should not.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">InformersStarted</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}

	<span style="color:#75715e">// ResyncPeriod generates a duration each time it is invoked; this is so that
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// multiple controllers don&#39;t get into lock-step and all hammer the apiserver
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// with list requests simultaneously.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ResyncPeriod</span> <span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>
}</code></pre></div>
<p>最后，会执行<code>leaderelection.RunOrDie</code>方法不断尝试获取或更新(<code>tryAcquireOrRenew</code>) leader lease，成功获取到的即为 leader，并执行上面的<code>run()</code>方法。实际上就是去获取一个锁并有一定有效期，当一个 contoller-manager 实例获取到锁并且超出了有效期，那么这个实例就会成为leader，成为 leader 的实例仍然会不断执行<code>tryAcquireOrRenew</code>来更新获取时间<code>AcquireTime</code>以延长有效期。(leader 选举的逻辑在 k8s.io\client-go\tools\leaderelection\leaderelection.go)</p>

<h2 id="controllers">controllers</h2>

<p>上面就是 controller-manager 的整体启动流程和代码结构。接下来会具体分析几个核心的 controller。</p>

<h3 id="replicasetcontroller">replicasetcontroller</h3>

<p>kubernetes\pkg\controller\replicaset\replica_set.go</p></article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="maoqide.live/tags/cloud"><span class="tag">Cloud</span></a></li>
        
          <li><a href="maoqide.live/tags/kubernetes"><span class="tag">Kubernetes</span></a></li>
        
          <li><a href="maoqide.live/tags/source-code"><span class="tag">Source-Code</span></a></li>
        
      </ul>
      
      <p class="post-copyright">
        © This post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License，please give source if you wish to quote or reproduce.This post was published <strong>105</strong> days ago, content in the post may be inaccurate, even wrong now, please take risk yourself.
      </p>
    </footer>
    
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "maoqide-1" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
    
  </section>
  
<footer class="site-footer">
  <p>© 2017-2019 Maoqide</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank" rel="noopener">Nuo</a>.</p>
  
    <p><a href="http://www.miitbeian.gov.cn" title="Check ICP info" target="_blank" rel="noopener">浙ICP备19006182号</a></p>
  
</footer>


<script src="https://cdn.jsdelivr.net/npm/smooth-scroll@15.0.0/dist/smooth-scroll.min.js"></script>



<script async src="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video.min.js"></script>




<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    },
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>



<script src="maoqide.live/scripts/index.min.js"></script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('\/service-worker.js').then(function() {
      console.log('[ServiceWorker] Registered');
    });
  }
</script>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-141682683-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c3c6dd2eb79bc741d95463b6040ac868";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>



  </body>
</html>
